#pragma once

#include <Arduino.h>

#include <BLE2902.h>
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>

#include <ArduinoJson.h>

// Message tracking
struct ReceivedMessage
{
    String characteristic;
    String jsonData;
    String timestamp;
};

void processConfigurationData(const String& characteristic, const String& data); // change or remove or move
class MyServerCallbacks : public BLEServerCallbacks
{
    void onConnect(BLEServer* pServer)
    {
        // TODO: add
        //  deviceConnected = true;
        //  dataTransmissionEnabled = true;
        Serial.println("ðŸ“± Device connected - Starting sensor data transmission");
    };

    void onDisconnect(BLEServer* pServer)
    {
        // TODO: add
        //  deviceConnected = false;
        //  dataTransmissionEnabled = false;
        Serial.println("ðŸ“± Device disconnected - Stopping sensor data transmission");
    }
};

class ConfigCharacteristicCallbacks : public BLECharacteristicCallbacks
{
  private:
    const char* characteristicName;

  public:
    ConfigCharacteristicCallbacks(const char* name) : characteristicName(name)
    {
    }

    void onWrite(BLECharacteristic* pCharacteristic)
    {
        size_t length = pCharacteristic->getValue().length();

        if (length > 0 && length < 4096)
        {
            String data = String(pCharacteristic->getValue().c_str());
            String characteristic = String(characteristicName);

            Serial.printf("ðŸ“¡ Received %s configuration (%zu bytes)\n", characteristicName, length);
            processConfigurationData(characteristic, data);
        }
    }
};

class NexusBLE
{
  public:
    NexusBLE();
    ~NexusBLE();

  private:
    void initBLE();
    void sendRealTimeData();

    // Timing for sensor data transmission
    unsigned long lastSensorUpdate = 0;
    const unsigned long SENSOR_UPDATE_INTERVAL = 5000; // 5 seconds

    // Connection status
    bool m_DeviceConnected = false;
    bool m_OldDeviceConnected = false;
    bool m_DataTransmissionEnabled = false;
};
